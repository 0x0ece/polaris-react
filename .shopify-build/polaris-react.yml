containers:
  default:
    docker: gcr.io/shopify-docker-images/apps/production/web-platform-ci-node:10.11.0-yarn-1.12.3
  styleguide:
    docker: circleci/node:10.13.0

shared:
  build-web: &build-web
    label: 'Build web'
    container: default
    timeout: 35m
    dependencies:
      - yarn
      - bundler
    run:
      - bundle exec eval $(ejson2env test.ejson)
      - yarn run build
      - ./.shopify-build/deploy-alpha-package.sh
      - ./.shopify-build/setup-consumer-test.sh web
      - yarn --cwd ./web run build
  build-styleguide: &build-styleguide
    label: 'Build styleguide'
    container: styleguide
    timeout: 20m
    dependencies:
      - yarn
    run:
      - yarn run build
      - ./.shopify-build/setup-consumer-test.sh polaris-styleguide
      - yarn --cwd ./polaris-styleguide run build
  unit-tests: &unit-tests
    label: 'ðŸ¤“ Web unit tests'
    container: default
    timeout: 15m
    dependencies:
      - yarn
    run:
      - yarn run build
      - ./.shopify-build/setup-consumer-test.sh web
      - cd ./web
      - node ./.shopify-build/balancer.js
      - CI=true yarn run sewing-kit test --maxWorkers 2 --coverage $(./.shopify-build/balancer.js)
    parallelism: 8
  release-private-npm-package: &release-private-npm-package
    label: 'Release private npm package'
    container: packagecloud
    timeout: 20m
    dependencies:
      - yarn
    run:
      - yarn run build
      - ./.shopify-build/deploy-to-private.sh
      - yarn run publish

steps:
  - <<: *build-styleguide
  - trigger: 'web-ci-builder'
    label: 'Run web build'
    build:
      # branch: '${BUILDKITE_BRANCH}-alpha'
      branch: 'master'
      commit: 'HEAD'
  # - <<: *unit-tests
